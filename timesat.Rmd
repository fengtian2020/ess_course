---
title: "TIMESAT和MODIS物候分析实验指导"
author: "田丰"
date: "`r Sys.Date()`"
output: html_document
---

[TIMESAT软件](https://web.nateko.lu.se/timesat/timesat.asp)是由瑞典隆德大学的[Lars Eklundh](https://web.nateko.lu.se/Personal/Lars.Eklundh/)及瑞典马尔默大学的
[Per Jönsson](https://mau.se/en/persons/per.jonsson/)在大约20年前开发的遥感物候分析工具，被全球遥感界广泛使用。TIMESAT使用[FORTRAN语言](https://baike.baidu.com/item/FORTRAN%E8%AF%AD%E8%A8%80/295590)编写，该语言面向科学计算，相较于其他编程语言，其运算效率号称是最快的。

本页介绍利用TIMESAT软件和MODIS NDVI产品进行物候分析，包括：数据下载、数据准备、数据处理、结果制图、分析整个过程，详细英文教程可以参见[TIMESAT用户手册](/)

# MODIS NDVI 标准产品

`NDVI`是`MODIS`的标准产品之一，包括16天合成和月合成两种时间分辨率、250米/500米/1公里/0.05度四种空间分辨率，网址：<https://modis.gsfc.nasa.gov/data/dataprod/mod13.php>，其中`MOD13`来自上午星`TERRA`，`MYD13`来自下午星`AQUA`。

<center>

<img src="img/MOD13products.png" width="800"/>

</center>

我们使用16天合成的1公里分辨率的 `MOD13A2 v061` 版产品为例进行实验，其详细介绍在：<https://lpdaac.usgs.gov/products/mod13a2v061/>.

<center>

<img src="img/MOD13A2.png" width="800"/>

</center>

数据获取途径有很多，我们使用[AppEEARS](https://lpdaacsvc.cr.usgs.gov/appeears/)

<center>

<img src="img/AppEEARS.png" width="800"/>

</center>

# AppEEARS 数据下载流程

首先登录账户，点击菜单栏中的`Extract` → `Area`，然后选择`Start a new request`。

<center>

<img src="img/modis_download_0.png" width="800"/>

</center>

选择一个感兴趣区域，可以利用交互式地图选取，这里我们用方框选取从北方草原到南方森林的一个长条地区作为实验区，选择这里纯粹是个人爱好，你也可以选取其他任何区域，但是要注意实验区的面积越大，你处理的数据量也就越大。给自己选定的区域一个名称，这里我们输入`modis_course`。

<center>

<img src="img/modis_download_1.png" width="800"/>

</center>

指定影像数据的开始时间和结束时间，这里我们选择2011年到2021年。
在`Select the layers to include in the Sample`对话框中，输入`MOD13A2`，找到`Terra MODIS Vegetation Indices (NDVI & EVI) MOD13A2.061`并选择。在图层中选择`NDVI`和`pixel_reliability`。

<center>

<img src="img/modis_download_2.png" width="800"/>

</center>

`pixel_reliability`为数据质量概要信息，可以用来过滤掉质量差的数据点（去噪），下图为MOD13用户手册中的介绍：

<center>

<img src="img/modis_download_2_1.png" width="600"/>

</center>

然后就可以点击提交了，之后从菜单栏的`Explore`里，可以看到你数据申请的处理状态，等到完成后(Done)，就可以下载了，我们需要NDVI和pixel_reliability两个数据。

<center>

<img src="img/modis_download_3.png" width="800"/>

</center>

如果下载过程因网络不稳定而中断了，可以利用搜索栏，选择未完成的文件继续下载。

<center>

<img src="img/modis_download_4.png" width="800"/>

</center>

# 数据预处理

下面我们将使用R编程，按照TIMESAT对输入数据的格式要求，对下载MODIS数据进行预处理。

## 文件组织

创建一个文件夹进行实验操作，其格式如下：

<center>

<img src="img/folders_1.png" width="600"/>

</center>

将MODIS NDVI的tif文件拷贝到`..\data\GeoTIFF\NDVI`中，质量标识文件 pixel reliability的tif文件拷贝到`..\data\GeoTIFF\QA`中。注意这两组数据应一一对应，以我们这个实验为例，NDVI和pixel reliability分别有253个文件，从2011年到2021年，每年23个16天合成的数据。

## 影像数据格式转换

将下载的GeoTIFF数据转成二进制ENVI格式才能输入到TIMESAT中。ENVI软件的数据格式既是二进制+头文件(`*.hdr`，对二进制文件的解释)。

这里，我们用R代码进行格式转换。首先，打开`RStudio`，新建R Script文件：

<center>

<img src="img/r_1.png" width="800"/>

</center>

将以下代码粘贴到新建的R Script文件中，并保存在`Rcode`文件夹下。注意根据你的实际情况修改文件路径。


```
#加载需要用的软件包
if (!require("tidyverse")) install.packages("tidyverse"); library(tidyverse)
if (!require("terra")) install.packages("terra"); library(terra)

# 获取tif数据文件的路径列表
tif_files <- list.files(path = "D:/modis/data/GeoTIFF", 
                        pattern = ".tif",
                        full.names = TRUE,
                        recursive = TRUE)

# 准备envi输出文件的路径列表
envi_files <- tif_files %>% str_replace(".tif", ".envi") %>% 
  str_replace("GeoTIFF", "ENVI")

# 读取tif文件为栅格数据
data <- rast(tif_files)

# 生成envi格式的文件
writeRaster(data, filename = envi_files)

# 准备envi格式数据列表的list文件，用于TIMESAT读取
num <- length(envi_files) / 2 # 影像时间序列个数

# 将文件分隔符从“/” 转成 “\”
envi_files_b <- str_replace_all(envi_files, "/", "\\\\") 

# 分别取出 NDVI 和 QA 文件路径列表
ndvi_envi_files_b <- str_subset(envi_files_b, "NDVI")
qa_envi_files_b <- str_subset(envi_files_b, "pixel_reliability")

#按照TIMESAT要求的格式组织NDVI list文件，并输出txt文件
append(as.character(num), ndvi_envi_files_b) %>% 
  as.data.frame() %>% 
  write.table(file = "D:/modis/data/NDVI_list.txt",
            sep = "\n", quote = FALSE, 
            row.names = FALSE, col.names = FALSE)

#按照TIMESAT要求的格式组织QA list文件，并输出txt文件
append(as.character(num), qa_envi_files_b) %>% 
  as.data.frame() %>% 
  write.table(file = "D:/modis/data/QA_list.txt",
              sep = "\n", quote = FALSE, 
              row.names = FALSE, col.names = FALSE)

```

## 转换后的文件

转换完成后，`data/ENVI`文件夹中应该看到envi格式的NDVI和QA数据，如下图所示：

<center>

<img src="img/folders_2.png" width="800"/>

</center>

其中`.hdr`为头文件，包含了envi二进制数据的信息，可以用文本编辑器打开查看，如行列数、数据类型、投影等：

<center>

<img src="img/envi_hdr.png" width="800"/>

</center>

`data`文件夹中会生成两个txt文件，分别为NDVI和pixel_reliability文件的路径列表(list)，会作为TIMESAT软件的输入文件使用。txt文件的第一行为输入数据的总个数，这里是230 个 = 23个/年 * 10年：

<center>

<img src="img/folders_3.png" width="800"/>

</center>

至此，数据准备完成，可以打开matlab运行TIMESAT软件了。


# matlab设置

将实验文件夹设为工作目录，这里是`D:\modis`。然后点击`Set Path`添加`TIMESAT`软件的路径：

<center>

<img src="img/matlab_1.png" width="800"/>

</center>

选择`Add with Subfolders..`，导航到timesat33软件的路径，选择`timesat_matlab`文件夹：

<center>

<img src="img/matlab_2.png" width="800"/>

</center>


<center>

<img src="img/matlab_3.png" width="800"/>

</center>


<center>

<img src="img/matlab_4.png" width="800"/>

</center>

然后在matlab命令行输入`timesat`，回车，就可以打开软件界面啦，包含三个模块：

<center>

<img src="img/matlab_5.png" width="600"/>

</center>

# TIMESAT查看数据和生成设置文件

点击`TSM_imageview`，打开之后选择`File → open file list`：

<center>

<img src="img/view1.png" width="800"/>

</center>

选择之前在R中生成的list文件`..data/NDVI_list.txt`，在TSM_imageview窗口中输入影像的数据类型、行列数，这些信息可以打开任一个ENVI的头文件.hdr获取，填好以后，点击`Draw`，就可以看到实验区NDVI的空间分布了，在列表中选择任一个时间的文件，点击`Draw`之后就会更新：

<center>

<img src="img/view2.png" width="800"/>

</center>


点击`TSM_GUI`，打开之后选择`File → Open list image files`：

<center>

<img src="img/view3.png" width="800"/>

</center>

选择之前在R中生成的NDVI和QA的list文件，配置如下所示：

<center>

<img src="img/view4.png" width="600"/>

</center>

其中，QA用来根据不同数据质量赋予NDVI观测点权重，这里我们把天空晴朗的无云观测(QA值为0)赋予权重为1；把数据质量一般的观测(QA值为1)赋予权重为0.5，有云和雪覆盖的观测(QA值为2-3)赋予权重为0。

点击`Show image`可以选择显示时间序列的窗口范围：`Rows to process`和`Columns to process`:

<center>

<img src="img/view5.png" width="600"/>

</center>

选择完成之后，点击`Load data`就可以看到时间序列啦：

<center>

<img src="img/view6.png" width="600"/>

</center>

这里是查看时间序列、选定拟合函数、以及设置各种物候提取参数的界面，尝试点击调整不同的设置，探索最佳的或可以接受的参数设置，然后选择`Settings → Save to settings file` 来设置`settings`文件：

<center>

<img src="img/settings1.png" width="600"/>

</center>

检查一下设置，然后就可以保存设置文件到`/run`文件夹了。这里可以为每一种植被类型(`Land cover`)设置不同的参数，我们暂且用同一种参数实验。准备好`settings`文件后，就可以运行处理了。

# TIMESAT执行数据处理

## 单核处理

点击`TSF_process`，选择配置文件`modis.set`：

<center>

<img src="img/process1.png" width="800"/>

</center>

桌面会弹出`cmd`窗口，`TIMESAT`开始逐行处理影像时间序列：

<center>

<img src="img/process2.png" width="800"/>

</center>

## 并行处理

如果数据处理量较大，`TIMESAT`还提供了并行处理。可以按`Ctrl + c`停止，然后点击`TSF_process parallel`，键入想要使用的处理器个数(最好不要把所有的`CUP`都占用，容易死机)：

<center>

<img src="img/process3.png" width="800"/>

</center>

<center>

<img src="img/process4.png" width="300"/>

</center>

然后，会弹出`cmd`窗口，同时`TIMESAT`会将生成相应个数的`settings`文件，以及`.bat`批处理文件。在`cmd`窗口中键入 `.bat`文件名，`TIMESAT`就开始进行并行处理了：

<center>

<img src="img/process5.png" width="800"/>

</center>

处理完成后，`/run`文件夹中会生成`.tts`、`.tpa`、`.ndx`文件，这是TIMESAT的中间文件，可以用来查看处理结果，经过后处理即可生成ENVI二进制格式的物候参数了。

<center>

<img src="img/process6.png" width="500"/>

</center>

# TIMESAT结果查看和后处理

## 生成拟合时间序列影像

曲线拟合可以将原始数据中存在云污染等的观测值进行填补，生成时空连续的影像序列，TIMESAT输出拟合之后的时空连续影像操作如下：点击`TSF_fit2img`：

<center>

<img src="img/results1.png" width="800"/>

</center>

按照提示在cmd窗口中键入参数，生成结果：

<center>

<img src="img/results2.png" width="800"/>

</center>

利用如下R代码生成list文件txt方便使用TIMESAT的`TSM_imageview`查看拟合后的影像(记得根据自己实际情况更改文件路径)：

```
# 生成TIMESAT读list需要的txt文件

#加载需要用的软件包
if (!require("tidyverse")) install.packages("tidyverse"); library(tidyverse)

# 获取影像数据文件的路径列表
files <- list.files(path = "D:/modis/run", 
                    pattern = "modis_fited_image_",
                    full.names = TRUE)

# 准备数据列表的list文件，用于TIMESAT读取
num <- length(files)  # 影像时间序列个数
files_b <- str_replace_all(files, "/", "\\\\") # 将文件分隔符从“/” 转成 “\”

#按照TIMESAT要求的格式组织NDVI list文件，并输出txt文件
append(as.character(num), files_b) %>% 
  as.data.frame() %>% 
  write.table(file = "D:/modis/run/modis_fited_image_list.txt",
              sep = "\n", quote = FALSE, 
              row.names = FALSE, col.names = FALSE)
              
```

<center>

<img src="img/results3.png" width="800"/>

</center>


## 生成物候参数影像

点击`TSF_seas2img`生成物候参数影像：

<center>

<img src="img/postprocess1.png" width="800"/>

</center>

按照提示输入参数：

<center>

<img src="img/postprocess2.png" width="800"/>

</center>

使用`TSM_imageview`查看物候参数：


<center>

<img src="img/postprocess3.png" width="800"/>

</center>
